name: C/C++ CI

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v1
    - name: Install ubuntu libs
      run: sudo apt-get install mlocate nasm wget pkg-config libglfw3-dev cython python-pyqt5 python-pyqt5.qtsvg
    - name: ffmpeg
      run: |
        export PREFIX=$HOME/env
        export PKG_CONFIG_PATH=$PREFIX/lib/pkgconfig
        echo "mrs -----FFMPEG"
        wget -q https://ffmpeg.org/releases/ffmpeg-4.2.1.tar.bz2
        tar -xf ffmpeg-4.2.1.tar.bz2
        cd ffmpeg-4.2.1
        ./configure --enable-debug --disable-stripping --disable-doc \
        --disable-autodetect --enable-zlib --disable-everything \
        --enable-filter='aformat,aresample,asetnsamples,asettb,copy,format,fps,hflip,settb,scale,transpose,vflip' \
        --disable-programs --enable-avdevice --enable-swresample \
        --enable-bsf='aac_adtstoasc,h264_mp4toannexb' \
        --enable-demuxer='aac,image_jpeg_pipe,image_pgm_pipe,image_png_pipe,rawvideo,mp3,mp4,mov,wav,flac,matroska,mpegts' \
        --enable-decoder='mjpeg,png,rawvideo,mp3,pcm_s16le,pcm_s16be,mpeg4,aac,pgm,flac,webp,wmv1,wmv2,wmv3,h264' \
        --enable-parser='mjpeg,png,h264,aac,flac' \
        --enable-protocol='file,http' --enable-shared --disable-static --prefix=$PREFIX 
        make -j8
        echo "mrs -----FFMPEG END"
        make install 
        sudo updatedb
        echo $?
        find $PREFIX
    - name: Build sxplayer ngl-tools libnodegl 
      run: |
        export PREFIX=$HOME/env
        export PKG_CONFIG_PATH=$PREFIX/lib/pkgconfig
        echo "mrs -----WHO AM I"
        lsb_release -a 
        echo "mrs -----LIST DIRECTORIES"
        ls  
        echo "mrs -----CLONE SXPLAYER"
        wget -q https://github.com/Stupeflix/sxplayer/archive/v9.5.0.tar.gz -O sxplayer.tar.gz
        tar -xf sxplayer.tar.gz
        echo "mrs -----LIST DIRECTORIES"
        ls
        echo "mrs -----DISPLAY VARIABLES"
        export NGLDIR=$HOME
        export PATH=$PATH:$HOME/.local/bin:$PREFIX/bin
        echo "mrs -----CREATION DE ENV"
        mkdir -p $NGLDIR/env
        echo "mrs -----NGLDIR:" $NGLDIR
        echo "mrs -----PATH:" $PATH
        echo "mrs -----MAKE ALIAS"
        alias make="make -j8"
        echo "mrs -----GO INTO SXPLA"
        cd sxplayer-9.5.0
        echo "mrs -----MAKE INST"
        LDFLAGS=-Wl,-rpath,$PREFIX/lib make install PREFIX=$PREFIX SHARED=yes
        echo $?
        echo "mrs -----MAKE END"
        echo "GO INTO LIBNODEGL"
        cd ../libnodegl
        echo "mrs -----MAKE INST2"
        LDFLAGS=-Wl,-rpath,$PREFIX/lib make install PREFIX=$PREFIX SHARED=yes
        echo $?
        echo "mrs -----MAKE END2"
        echo "mrs -----GO INTO NGLTOOLS"
        cd ../ngl-tools
        echo "mrs -----MAKE INST3"
        LDFLAGS=-Wl,-rpath,$PREFIX/lib make install PREFIX=$PREFIX
        echo $?
        find $PREFIX
        echo "mrs -----MAKE END3"
        cd ..
        ls

    - name: Python packages 
      run: |
        export PREFIX=$HOME/env
        export PKG_CONFIG_PATH=$PREFIX/lib/pkgconfig
        export NGLDIR=$HOME
        echo "mrs -----UPDATE"
        sudo apt-get update
        echo "mrs -----PYTHONPIP"
        sudo apt-get install python-pip
        echo "mrs -----VERSION"
        pip --version
        echo "mrs -----PYNODEGL"
        LDFLAGS=-Wl,-rpath,$PREFIX/lib pip2 install --user -e ./pynodegl
        echo "mrs -----pynodegl2"
        pip2 install --user -r ./pynodegl-utils/requirements.txt
        echo "mrs -----pynodegl3"
        LDFLAGS=-Wl,-rpath,$PREFIX/lib pip2 install --user -e ./pynodegl-utils
        echo "mrs -----libnodegl"
        pkg-config --modversion libnodegl  

    - name: Run tests
      run: |
        export PREFIX=$HOME/env
        export PKG_CONFIG_PATH=$PREFIX/lib/pkgconfig
        echo "mrs -----GO INTO TESTS"
        cd tests
        ls 
        echo "mrs -----make tests_api "
        LDFLAGS=-Wl,-rpath,$PREFIX/lib make tests_api 
 